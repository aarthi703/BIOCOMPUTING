
#!/bin/bash

set -euo pipefail

echo "initialize and activate conda environment"

module load miniforge3

source /sciclone/apps/miniforge3-24.9.2-0/etc/profile.d/conda.sh

echo "If you need to create the environment: conda create -y -n bbmap-env bbmap -c bioconda"

conda create -y -n bbmap-env bbmap -c bioconda

conda activate bbmap-env

conda env export --no-builds > bbmap-env.yml

REF="${HOME}/scr10/data/dog_reference/ncbi_dataset/data/GCF_011100685.1/GCF_011100685.1_UU_Cfam_GSD_1.0_genomic.fna"

#samtools

module load samtools/gcc-11.4.1/

samtools --version



for i in ${HOME}/scr10/data/clean/*_1_*

do

BASE=$(basename "$i" _1_cleaned_trimmed.fastq.gz)

REV="${HOME}/scr10/data/clean/${BASE}_2_cleaned_trimmed.fastq.gz"

SAM_OUTPUT="${HOME}/scr10/output/${BASE}.sam"


if [[ -f ${HOME}/scr10/output/${BASE}_dog-matches.sam ]]; then
    echo "Skipping ${BASE} â€” already mapped (${HOME}/scr10/output/${BASE}_dog-matches.sam exists)."
    continue
fi


bbmap.sh -Xmx20g ref=${REF} in1=${i} in2=${REV} out=${SAM_OUTPUT} nodisk=t ambiguous=best minid=0.95


samtools view -F 4 -h ${SAM_OUTPUT} > ${HOME}/scr10/output/${BASE}_dog-matches.sam

done

conda deactivate
